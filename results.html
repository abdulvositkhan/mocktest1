<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Test Natijalari</title>

<style>
*{box-sizing:border-box;font-family:Arial,sans-serif}
body{margin:0;min-height:100vh;background:#f0fdf4;display:flex;justify-content:center;padding:30px}
.container{width:100%;max-width:1100px;background:#fff;padding:30px;border-radius:22px;border:2px solid #e5e7eb;box-shadow:0 25px 50px rgba(0,0,0,0.15)}
h1,h2{text-align:center;margin-top:0}
.summary{text-align:center;padding:25px;border-radius:18px;margin-bottom:30px}
.red{background:#fee2e2}
.orange{background:#ffedd5}
.yellow{background:#fef9c3}
.blue{background:#dbeafe}
.big{font-size:38px;font-weight:bold}
.user{font-size:20px;margin-bottom:10px}
.time{margin-top:8px;color:#374151}
.actions{display:flex;justify-content:center;gap:15px;margin-bottom:25px}
.actions button{padding:12px 18px;font-weight:bold;border:none;border-radius:10px;cursor:pointer;background:#4f46e5;color:white}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{border:1px solid #e5e7eb;padding:12px;text-align:center}
th{background:#f3f4f6}
tr:nth-child(even){background:#f9fafb}
.low{color:#dc2626;font-weight:bold}
.mid{color:#d97706;font-weight:bold}
.high{color:#16a34a;font-weight:bold}
.detail{border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin-top:10px}
.ok{background:#ecfdf5}
.bad{background:#fee2e2}
.footer{margin-top:40px;text-align:center;font-weight:bold;color:#4f46e5}
</style>
</head>
<body>

<div class="container">
<h1>üìä Test Natijalari</h1>

<div class="actions" id="adminActions">
  <button onclick="exportExcel()">üì• Excel yuklab olish</button>
  <button onclick="exportPDF()">üìÑ PDF yuklab olish</button>
</div>

<div id="summary"></div>

<!-- ADMIN -->
<div id="adminBlock">
  <h2>üìã Barcha natijalar</h2>
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Ism</th>
        <th>Familiya</th>
        <th>Ball</th>
        <th>Tugagan vaqt</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<!-- STUDENT -->
<div id="studentBlock" style="display:none">
  <h2>üìù Sizning javoblaringiz</h2>
  <div id="details"></div>
</div>

<div class="footer">@Ped_Life_Uz</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* üî• FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyDMyRSvTXXxkgTPyeZSeVnpHgh1tH4lJjE",
  authDomain: "mock-8b900.firebaseapp.com",
  projectId: "mock-8b900",
  storageBucket: "mock-8b900.appspot.com",
  messagingSenderId: "316652697568",
  appId: "1:316652697568:web:7b6b24a3aefc44dcd1dd85"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* VIEW MODE */
const viewer = sessionStorage.getItem("viewer") || "student";
const currentUser = JSON.parse(sessionStorage.getItem("currentUser") || "{}");

const summary = document.getElementById("summary");
const rows = document.getElementById("rows");
const details = document.getElementById("details");

if(viewer === "student"){
  document.getElementById("adminBlock").style.display="none";
  document.getElementById("adminActions").style.display="none";
  document.getElementById("studentBlock").style.display="block";
}else{
  document.getElementById("studentBlock").style.display="none";
}

/* LOAD RESULTS */
db.collection("results").orderBy("time","desc").get().then(snap=>{
  if(snap.empty){
    summary.innerHTML="<b>Natija topilmadi</b>";
    return;
  }

  const all = [];
  snap.forEach(d=>all.push(d.data()));

  const last = viewer==="student"
    ? all.find(r=>r.ism===currentUser.ism && r.familiya===currentUser.familiya)
    : all[0];

  if(!last) return;

  const ball = last.ball;
  let cls="red", text="Attestatsiya Mock testidan o‚Äòtmadingiz";
  if(ball>=80){cls="blue";text="Oliy toifa balini to‚Äòpladingiz";}
  else if(ball>=70){cls="yellow";text="Birinchi toifa balini to‚Äòpladingiz";}
  else if(ball>=60){cls="orange";text="Ikkinchi toifa balini to‚Äòpladingiz";}

  summary.innerHTML=`
    <div class="summary ${cls}">
      <div class="user">${last.ism} ${last.familiya}</div>
      <div class="big">${ball}/100</div>
      <div>${text}</div>
      <div class="time">Tugagan vaqt: ${last.time}</div>
    </div>`;

  /* ADMIN TABLE */
  if(viewer!=="student"){
    all.forEach((r,i)=>{
      const c=r.ball>=80?"high":r.ball>=60?"mid":"low";
      rows.innerHTML+=`
        <tr>
          <td>${i+1}</td>
          <td>${r.ism}</td>
          <td>${r.familiya}</td>
          <td class="${c}">${r.ball}</td>
          <td>${r.time}</td>
        </tr>`;
    });
  }

  /* STUDENT DETAILS */
  if(viewer==="student" && last.answers){
    last.answers.forEach((a,i)=>{
      details.innerHTML+=`
        <div class="detail ${a.ok?'ok':'bad'}">
          ${i+1}. ${a.text}
        </div>`;
    });
  }
});

/* EXPORT */
function exportExcel(){
  db.collection("results").get().then(snap=>{
    const data=[];
    snap.forEach(d=>data.push(d.data()));
    const ws=XLSX.utils.json_to_sheet(data.map(r=>({
      Ism:r.ism,
      Familiya:r.familiya,
      Ball:r.ball,
      Vaqt:r.time
    })));
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Natijalar");
    XLSX.writeFile(wb,"natijalar.xlsx");
  });
}

function exportPDF(){
  const { jsPDF } = window.jspdf;
  const pdf=new jsPDF();
  pdf.text("Test Natijalari",14,15);
  let y=25;
  db.collection("results").get().then(snap=>{
    snap.forEach((d,i)=>{
      const r=d.data();
      pdf.text(`${i+1}. ${r.ism} ${r.familiya} ‚Äî ${r.ball} ‚Äî ${r.time}`,14,y);
      y+=8;
    });
    pdf.save("natijalar.pdf");
  });
}
</script>

</body>
</html>

