<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel ‚Äî Test Natijalari</title>

<style>
*{box-sizing:border-box;font-family:Inter,Arial,sans-serif}
body{
  margin:0;
  min-height:100vh;
  background:linear-gradient(135deg,#eef2ff,#ecfdf5);
  padding:30px;
}
.container{
  max-width:1200px;
  margin:auto;
  background:#fff;
  padding:32px;
  border-radius:28px;
  box-shadow:0 40px 100px rgba(0,0,0,.15);
}
h1{
  text-align:center;
  margin-top:0;
  font-size:32px;
  font-weight:900;
  color:#1e293b;
}

/* ACTIONS */
.actions{
  display:flex;
  justify-content:center;
  gap:14px;
  margin:25px 0;
}
.actions button{
  padding:12px 22px;
  border:none;
  border-radius:14px;
  font-weight:900;
  cursor:pointer;
  background:linear-gradient(135deg,#6366f1,#4f46e5);
  color:#fff;
}

/* RESULT LIST */
.result-list{
  margin-top:30px;
}
.result-card{
  display:grid;
  grid-template-columns: 60px 1.5fr 1fr 1fr 120px 100px;
  gap:12px;
  align-items:center;
  padding:18px;
  margin-bottom:14px;
  border-radius:20px;
  background:#f8fafc;
  border:1px solid #e5e7eb;
  transition:.2s;
}
.result-card:hover{
  transform:translateY(-2px);
  box-shadow:0 10px 30px rgba(0,0,0,.12);
}
.index{
  font-weight:900;
  font-size:20px;
  color:#475569;
}
.name{
  font-weight:900;
  font-size:17px;
}
.testid{
  font-size:14px;
  color:#64748b;
}
.time{
  font-size:14px;
  color:#475569;
}
.score{
  font-weight:900;
  font-size:18px;
  padding:6px 14px;
  border-radius:999px;
  text-align:center;
}
.score.blue{background:#dbeafe;color:#1d4ed8}
.score.yellow{background:#fef9c3;color:#854d0e}
.score.orange{background:#ffedd5;color:#9a3412}
.score.red{background:#fee2e2;color:#991b1b}
.view-btn{
  padding:10px 16px;
  border:none;
  border-radius:12px;
  cursor:pointer;
  font-weight:900;
  background:#4f46e5;
  color:#fff;
}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999;
}
.modal-box{
  background:#fff;
  width:100%;
  max-width:820px;
  max-height:90vh;
  overflow:auto;
  padding:30px;
  border-radius:26px;
  box-shadow:0 30px 80px rgba(0,0,0,.35);
}
.close{
  float:right;
  cursor:pointer;
  font-size:18px;
  font-weight:900;
}
.question{
  border:1px solid #e5e7eb;
  border-radius:18px;
  padding:18px;
  margin-top:18px;
}
.question img{
  max-width:220px;
  margin:10px 0;
  border-radius:12px;
}
.option{
  margin-top:6px;
  font-weight:700;
}
.correct{color:#16a34a}
.wrong{color:#dc2626}

.footer{
  text-align:center;
  margin-top:40px;
  font-weight:900;
  color:#4f46e5;
}
</style>
</head>

<body>

<script>
/* ADMIN SECURITY */
if(sessionStorage.getItem("viewer")!=="admin"){
  alert("Ruxsat yo‚Äòq");
  location.href="index.html";
}
</script>

<div class="container">
  <h1>üìä Test Natijalari ‚Äî Admin Panel</h1>

  <div class="actions">
    <button onclick="exportExcel()">üì• Excel</button>
    <button onclick="exportPDF()">üìÑ PDF</button>
  </div>

  <div class="result-list" id="resultList"></div>

  <div class="footer">@Ped_Life_Uz</div>
</div>

<!-- DETAIL MODAL -->
<div class="modal" id="detailModal">
  <div class="modal-box">
    <span class="close" onclick="detailModal.style.display='none'">‚úñ</span>
    <h2>üìù Test tahlili</h2>
    <div id="detailBody"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDMyRSvTXXxkgTPyeZSeVnpHgh1tH4lJjE",
  authDomain:"mock-8b900.firebaseapp.com",
  projectId:"mock-8b900"
});
const db=firebase.firestore();

const list=document.getElementById("resultList");
const detailBody=document.getElementById("detailBody");

/* LOAD RESULTS ‚Äî BALL BO‚ÄòYICHA */
db.collection("results")
  .orderBy("ball","desc")
  .orderBy("time","desc")
  .get()
  .then(snap=>{
    let i=1;
    snap.forEach(d=>{
      const r=d.data();
      let cls="red";
      if(r.ball>=80) cls="blue";
      else if(r.ball>=70) cls="yellow";
      else if(r.ball>=60) cls="orange";

      list.innerHTML+=`
        <div class="result-card">
          <div class="index">${i++}</div>
          <div class="name">${r.ism} ${r.familiya}</div>
          <div class="testid">${r.testId}</div>
          <div class="time">${r.time}</div>
          <div class="score ${cls}">${r.ball} ball</div>
          <button class="view-btn" onclick='openDetail(${JSON.stringify(r)})'>Ko‚Äòrish</button>
        </div>
      `;
    });
  });

function openDetail(r){
  detailBody.innerHTML="";
  r.answers.forEach((a,i)=>{
    let html=`
      <div class="question">
        <b>${i+1}. ${a.question}</b><br>
        ${a.image?`<img src="${a.image}">`:""}
    `;
    for(const k in a.options){
      let cls="option";
      if(k===a.correct) cls+=" correct";
      if(k===a.selected && k!==a.correct) cls+=" wrong";
      html+=`<div class="${cls}">${k}) ${a.options[k]}</div>`;
    }
    html+=`
      <div style="margin-top:8px">
        Siz tanlagan: <b>${a.selected||"-"}</b> |
        To‚Äòg‚Äòri: <b>${a.correct}</b>
      </div>
      </div>`;
    detailBody.innerHTML+=html;
  });
  detailModal.style.display="flex";
}

/* EXPORT */
function exportExcel(){
  db.collection("results").get().then(snap=>{
    const data=[];
    snap.forEach(d=>data.push(d.data()));
    const ws=XLSX.utils.json_to_sheet(data.map(r=>({
      Ism:r.ism,
      Familiya:r.familiya,
      Test:r.testId,
      Ball:r.ball+" ball",
      Vaqt:r.time
    })));
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Natijalar");
    XLSX.writeFile(wb,"natijalar.xlsx");
  });
}

function exportPDF(){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();
  pdf.text("Test Natijalari",14,15);
  let y=25;
  db.collection("results").orderBy("ball","desc").get().then(snap=>{
    snap.forEach((d,i)=>{
      const r=d.data();
      pdf.text(`${i+1}. ${r.ism} ${r.familiya} ‚Äî ${r.ball} ball ‚Äî ${r.time}`,14,y);
      y+=8;
    });
    pdf.save("natijalar.pdf");
  });
}
</script>

</body>
</html>
