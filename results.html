<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Test Natijalari</title>

<style>
*{box-sizing:border-box;font-family:Inter,Arial,sans-serif}
body{
  margin:0;
  min-height:100vh;
  background:linear-gradient(135deg,#4f46e5,#22c55e);
  padding:30px;
}
.container{
  max-width:1250px;
  margin:auto;
  background:#fff;
  padding:34px;
  border-radius:30px;
  box-shadow:0 40px 100px rgba(0,0,0,.15);
}
h1{
  text-align:center;
  font-size:34px;
  font-weight:900;
  margin-top:0;
}

/* TEST SELECTOR */
.test-list{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  justify-content:center;
  margin:25px 0 30px;
}
.test-btn{
  padding:10px 20px;
  border-radius:999px;
  border:none;
  cursor:pointer;
  font-weight:900;
  background:#e0e7ff;
  color:#1e3a8a;
}
.test-btn.active{
  background:linear-gradient(135deg,#6366f1,#4f46e5);
  color:#fff;
}

/* SUMMARY */
.summary{
  text-align:center;
  padding:30px;
  border-radius:26px;
  margin-bottom:30px;
}
.summary.blue{background:#dbeafe}
.summary.yellow{background:#fef9c3}
.summary.orange{background:#ffedd5}
.summary.red{background:#fee2e2}
.big{
  font-size:46px;
  font-weight:900;
}
.badges{
  display:flex;
  justify-content:center;
  gap:16px;
  margin-top:14px;
}
.badge{
  padding:8px 20px;
  border-radius:999px;
  font-weight:900;
}
.ok{background:#dcfce7;color:#166534}
.no{background:#fee2e2;color:#991b1b}

/* TABLE */
.table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}
th,td{
  padding:14px;
  border-bottom:1px solid #e5e7eb;
  text-align:center;
}
th{background:#f1f5f9;font-weight:900}

.score{
  padding:6px 16px;
  border-radius:999px;
  font-weight:900;
}
.score.blue{background:#dbeafe;color:#1d4ed8}
.score.yellow{background:#fef9c3;color:#854d0e}
.score.orange{background:#ffedd5;color:#9a3412}
.score.red{background:#fee2e2;color:#991b1b}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.65);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999;
}
.modal-box{
  background:#fff;
  width:100%;
  max-width:900px;
  max-height:90vh;
  overflow:auto;
  padding:32px;
  border-radius:30px;
}
.close{
  float:right;
  cursor:pointer;
  font-weight:900;
}

.detail{
  border:1px solid #e5e7eb;
  border-radius:22px;
  padding:22px;
  margin-top:18px;
}
.option{margin-top:6px;font-weight:700}
.correct{color:#16a34a}
.wrong{color:#dc2626}

.footer{
  text-align:center;
  margin-top:40px;
  font-weight:900;
  color:#4f46e5;
}
  /* üìÅ FAN PAPKALARI (RESULTS UCHUN) */
.folder-btn{
  width:100%;
  text-align:left;
  background:#f8fafc;
  border:2px solid #e5e7eb;
  border-radius:16px;
  padding:14px 18px;
  font-weight:900;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
  margin:12px 0;
}

.folder-content{
  display:none;
  margin-top:10px;
  padding-left:10px;
}

</style>
</head>

<body>

<div class="container">
  <h1>üìä Test Natijalari</h1>

  <div id="testList" class="test-list"></div>
  <div id="summary"></div>

  <div id="rows"></div>


  <div class="footer">@Ped_Life_Uz</div>
</div>

<div class="modal" id="detailModal">
  <div class="modal-box">
    <span class="close" onclick="detailModal.style.display='none'">‚úñ</span>
    <h2>üß† Test tahlili</h2>
    <div id="modalDetails"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDMyRSvTXXxkgTPyeZSeVnpHgh1tH4lJjE",
  authDomain:"mock-8b900.firebaseapp.com",
  projectId:"mock-8b900"
});

const auth = firebase.auth();
auth.signInAnonymously().catch(err => {
  console.error("Anonymous auth error", err);
});

const db = firebase.firestore();


const viewer = sessionStorage.getItem("viewer")==="admin" ? "admin" : "student";
const user = JSON.parse(sessionStorage.getItem("currentUser")||"{}");

const testList=document.getElementById("testList");
const rows=document.getElementById("rows");
const summary=document.getElementById("summary");
const modalDetails=document.getElementById("modalDetails");

 let testSubjects = {}; // testId -> subject
let allResults = [];

Promise.all([
  db.collection("tests").get(),
  db.collection("results").orderBy("ball","desc").get()
]).then(([testsSnap, resultsSnap])=>{

  // 1Ô∏è‚É£ testId ‚Üí subject mapping
  testsSnap.forEach(doc=>{
    const t = doc.data();
    if(t.testId && t.subject){
      testSubjects[t.testId] = t.subject;
    }
  });

  // 2Ô∏è‚É£ results yig‚Äòiladi
  resultsSnap.forEach(doc=>{
    allResults.push(doc.data());
  });

  // 3Ô∏è‚É£ render
  if(viewer === "admin"){
    renderAdminBySubject();
  }else{
    renderStudent();
  }

}).catch(err=>{
  console.error("Yuklashda xatolik:", err);
});

function renderAdminBySubject(){
  rows.innerHTML = "";
  testList.style.display = "none";
  summary.innerHTML = "";

  const subjectGroups = {};

  // 1Ô∏è‚É£ Fan bo‚Äòyicha
  allResults.forEach(r=>{
    const subject = testSubjects[r.testId] || "Boshqa";
    if(!subjectGroups[subject]) subjectGroups[subject] = {};
    if(!subjectGroups[subject][r.testId]) subjectGroups[subject][r.testId] = [];
    subjectGroups[subject][r.testId].push(r);
  });

  let s = 0;
  for(const subject in subjectGroups){
    const subjectId = `subject_${s++}`;

    rows.innerHTML += `
      <div class="qitem">
        <button class="folder-btn" onclick="toggleFolder('${subjectId}', this)">
          üìÅ ${subject}
          <span>‚ñ∂</span>
        </button>

        <div class="folder-content" id="${subjectId}">
          ${renderTestsInSubject(subjectGroups[subject])}
        </div>
      </div>
    `;
  }
}


function renderTestsInSubject(tests){
  let html = "";
  let t = 0;

  for(const testId in tests){
    const testPanel = `test_${testId}_${t++}`;

    html += `
      <div style="margin-left:20px">
        <button class="folder-btn" onclick="toggleFolder('${testPanel}', this)">
          üìÑ ${testId}
          <span>‚ñ∂</span>
        </button>

        <div class="folder-content" id="${testPanel}">
          ${renderResultsByTest(tests[testId])}
        </div>
      </div>
    `;
  }
  return html;
}


function selectTest(id,btn){
  currentTestId=id;
  document.querySelectorAll(".test-btn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  renderAdminTable();
}
function toggleFolder(id, btn){
  const el = document.getElementById(id);
  const arrow = btn.querySelector("span");

  if(el.style.display === "block"){
    el.style.display = "none";
    arrow.innerText = "‚ñ∂";
  }else{
    el.style.display = "block";
    arrow.innerText = "‚ñº";
  }
}

function renderResultsByTest(list){
  return `
    <table class="table">
      <tbody>
        ${list.map((r,i)=>{
          let cls="red";
          if(r.ball>=80) cls="blue";
          else if(r.ball>=70) cls="yellow";
          else if(r.ball>=60) cls="orange";

          return `
            <tr>
              <td>${i+1}</td>
              <td>${r.ism}</td>
              <td>${r.familiya}</td>
              <td><span class="score ${cls}">${r.ball} ball</span></td>
              <td>${r.time}</td>
              <td>
                <button onclick='openDetail(${JSON.stringify(r)})'>
                  Ko‚Äòrish
                </button>
              </td>
            </tr>
          `;
        }).join("")}
      </tbody>
    </table>
  `;
}

/* STUDENT */
function renderStudent(){
  testList.style.display="none";
  const r=allResults
    .filter(x=>x.ism===user.ism&&x.familiya===user.familiya)
    .sort((a,b)=>new Date(b.time)-new Date(a.time))[0];
  if(!r) return;

  let cls="red",txt="Testdan o‚Äòtmadingiz";
  if(r.ball>=80){cls="blue";txt="Oliy toifa";}
  else if(r.ball>=70){cls="yellow";txt="Birinchi toifa";}
  else if(r.ball>=60){cls="orange";txt="Ikkinchi toifa";}

  summary.innerHTML=`
    <div class="summary ${cls}">
      <div class="big">${r.ball} ball</div>
      <div>${txt}</div>
      <div class="badges">
        <div class="badge ok">To‚Äòg‚Äòri: ${r.answers.filter(a=>a.selected===a.correct).length}</div>
        <div class="badge no">Noto‚Äòg‚Äòri: ${r.answers.length-r.answers.filter(a=>a.selected===a.correct).length}</div>
      </div>
    </div>`;
}

/* DETAIL */
function openDetail(r){
  modalDetails.innerHTML="";
  r.answers.forEach((a,i)=>{
    let html=`
      <div class="detail">
        <b>${i+1}. ${a.question}</b><br>
        ${a.image?`<img src="${a.image}" style="max-width:240px;margin:10px 0">`:""}
    `;
    for(const k in a.options){
      let cls="option";
      if(k===a.correct) cls+=" correct";
      if(k===a.selected&&k!==a.correct) cls+=" wrong";
      html+=`<div class="${cls}">${k}) ${a.options[k]}</div>`;
    }
    html+=`</div>`;
    modalDetails.innerHTML+=html;
  });
  detailModal.style.display="flex";
}
</script>

</body>
</html>





