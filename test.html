<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Test</title>

<style>
body{
  margin:0;
  background:#f0fdf4;
  font-family:Arial;
  display:flex;
  justify-content:center;
  padding:30px;
}
.container{
  width:100%;
  max-width:800px;
  background:#fff;
  padding:25px;
  border-radius:18px;
  box-shadow:0 20px 40px rgba(0,0,0,.15);
}
.timer{
  position:fixed;
  top:20px;
  right:20px;
  background:#dc2626;
  color:#fff;
  padding:10px 18px;
  border-radius:999px;
  font-weight:bold;
}
.q{
  font-size:22px;
  font-weight:bold;
}
.q img{max-width:100%;margin-top:10px}
.opt{
  margin-top:12px;
  padding:12px;
  border:2px solid #e5e7eb;
  border-radius:12px;
  cursor:pointer;
}
.opt.sel{
  background:#dbeafe;
  border-color:#2563eb;
}
.nav{
  display:flex;
  justify-content:space-between;
  margin-top:20px;
}
button{
  padding:12px 22px;
  border:none;
  border-radius:12px;
  background:#4f46e5;
  color:#fff;
  font-weight:bold;
  cursor:pointer;
}
.finish{
  width:100%;
  margin-top:20px;
  background:#16a34a;
}
</style>
</head>

<body>

<div class="timer" id="timer"></div>

<div class="container">
  <div id="qBox"></div>
  <div id="opts"></div>

  <div class="nav">
    <button onclick="prev()">⬅ Oldingi</button>
    <button onclick="next()">Keyingi ➡</button>
  </div>

  <button class="finish" id="finishBtn" onclick="finish()" style="display:none">
    TESTNI YAKUNLASH
  </button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDMyRSvTXXxkgTPyeZSeVnpHgh1tH4lJjE",
  authDomain:"mock-8b900.firebaseapp.com",
  projectId:"mock-8b900"
});
const db=firebase.firestore();

const testId=sessionStorage.getItem("currentTestId");
if(!testId){
  alert("Test topilmadi");
  location.href="index.html";
}

let test=null;
let i=0;
let answers={};
let timeLeft=0;

/* LOAD TEST */
db.collection("tests").doc(testId).get().then(doc=>{
  if(!doc.exists){
    alert("Test yo‘q");
    return;
  }
  test=doc.data();
  timeLeft=Number(test.duration||60)*60;
  startTimer();
  render();
});

/* TIMER */
function startTimer(){
  const t=setInterval(()=>{
    const m=Math.floor(timeLeft/60);
    const s=timeLeft%60;
    timer.innerText=`⏱ ${m}:${String(s).padStart(2,"0")}`;
    timeLeft--;
    if(timeLeft<0){
      clearInterval(t);
      finish();
    }
  },1000);
}

/* RENDER */
function render(){
  const q=test.questions[i];
  qBox.innerHTML=`
    <div class="q">
      ${i+1}. ${q.text}
      ${q.image?`<img src="${q.image}">`:""}
    </div>
  `;
  opts.innerHTML="";
  ["A","B","C","D"].forEach(k=>{
    if(!q.options[k]) return;
    const sel=answers[i]===k?"sel":"";
    opts.innerHTML+=`
      <div class="opt ${sel}" onclick="choose('${k}')">
        ${k}) ${q.options[k]}
      </div>
    `;
  });
  finishBtn.style.display=i===test.questions.length-1?"block":"none";
}

function choose(v){
  answers[i]=v;
  render();
}
function next(){
  if(i<test.questions.length-1){i++;render();}
}
function prev(){
  if(i>0){i--;render();}
}

function finish(){
  let correct=0;
  test.questions.forEach((q,idx)=>{
    if(answers[idx]===q.correct) correct++;
  });
  alert(`Test tugadi. Ball: ${correct*2}/100`);
}
</script>

</body>
</html>
