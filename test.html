<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mock Test</title>

<style>
*{box-sizing:border-box;font-family:Inter,Arial,sans-serif}
body{
  margin:0;
  min-height:100vh;
  background:linear-gradient(135deg,#eef2ff,#ecfdf5);
  display:flex;
  justify-content:center;
  padding:30px;
}
.container{
  width:100%;
  max-width:960px;
  background:#fff;
  padding:32px;
  border-radius:28px;
  box-shadow:0 40px 100px rgba(0,0,0,.15);
}
.timer{
  position:fixed;
  top:20px;
  right:20px;
  background:linear-gradient(135deg,#dc2626,#b91c1c);
  color:#fff;
  padding:14px 24px;
  border-radius:999px;
  font-size:20px;
  font-weight:900;
}
.banner{
  background:#fff7ed;
  border:2px solid #f59e0b;
  padding:18px;
  border-radius:20px;
  font-weight:800;
  text-align:center;
  margin-bottom:20px;
}
.question-box{
  min-height:240px;
  border:2px solid #e5e7eb;
  border-radius:24px;
  padding:26px;
  font-size:22px;
  font-weight:800;
  background:#f8fafc;
}
.q-image{
  margin-top:14px;
  max-height:220px;
  overflow:hidden;
  border-radius:14px;
}
.q-image img{
  max-width:100%;
  max-height:220px;
  object-fit:contain;
  display:block;
  margin:auto;
}
.option{
  display:flex;
  align-items:center;
  gap:14px;
  border:2px solid #e5e7eb;
  border-radius:16px;
  padding:16px;
  margin-top:14px;
  cursor:pointer;
  font-size:18px;
  transition:.2s;
}
.option::before{
  content:"";
  width:18px;
  height:18px;
  border-radius:50%;
  border:3px solid #c7d2fe;
}
.option:hover{border-color:#6366f1}
.option.selected{
  background:#eef2ff;
  border-color:#4f46e5;
}
.option.selected::before{
  background:#4f46e5;
  border-color:#4f46e5;
}
.option.correct{background:#dcfce7;border-color:#16a34a}
.option.wrong{background:#fee2e2;border-color:#dc2626}
.nav{
  display:flex;
  justify-content:space-between;
  margin-top:26px;
}
button{
  padding:14px 26px;
  font-size:16px;
  font-weight:900;
  border:none;
  border-radius:16px;
  cursor:pointer;
  background:linear-gradient(135deg,#6366f1,#4f46e5);
  color:white;
}
.finish{
  width:100%;
  margin-top:28px;
  background:linear-gradient(135deg,#22c55e,#16a34a);
}
.modal{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.65);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999;
}
.modal-box{
  background:#fff;
  padding:40px;
  border-radius:30px;
  width:100%;
  max-width:520px;
  text-align:center;
  box-shadow:0 40px 120px rgba(0,0,0,.4);
}
.score{font-size:48px;font-weight:900}
.badges{display:flex;justify-content:center;gap:14px;margin:16px 0}
.badge{padding:8px 18px;border-radius:999px;font-weight:900}
.ok{background:#dcfce7;color:#166534}
.no{background:#fee2e2;color:#991b1b}
.note{margin-top:8px;font-weight:700}
.modal-box.success{border-top:10px solid #2563eb}
.modal-box.gold{border-top:10px solid #facc15}
.modal-box.orange{border-top:10px solid #fb923c}
.modal-box.fail{border-top:10px solid #dc2626}

.result-time{
  margin-top:10px;
  font-weight:800;
  color:#475569
}

</style>
</head>

<body>

<div class="timer" id="timer"></div>

<div class="container" id="main"></div>

<div class="modal" id="resultModal">
  <div class="modal-box" id="resultBox">
    <h2 id="resultTitle"></h2>
    <div class="score" id="resultScore"></div>
    <div class="badges">
      <div class="badge ok" id="okCount"></div>
      <div class="badge no" id="noCount"></div>
    </div>
    <div class="result-time" id="resultTime"></div>
    <button onclick="showAnalysis()">Test Tahlili</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDMyRSvTXXxkgTPyeZSeVnpHgh1tH4lJjE",
  authDomain:"mock-8b900.firebaseapp.com",
  projectId:"mock-8b900"
});
const db=firebase.firestore();

const testId=sessionStorage.getItem("currentTestId");
const user=JSON.parse(sessionStorage.getItem("currentUser")||"{}");
if(!testId||!user.ism) location.href="index.html";

let deviceId=localStorage.getItem("deviceId");
if(!deviceId){
  deviceId=crypto.randomUUID();
  localStorage.setItem("deviceId",deviceId);
}

let test,index=0,answers={},timeLeft=0,finalResult=null,interval=null;

function saveProgress(){
  localStorage.setItem("progress_"+testId,JSON.stringify({
    testId,deviceId,index,answers,timeLeft,version:test.version||1
  }));
}

function loadProgress(){
  const raw=localStorage.getItem("progress_"+testId);
  if(!raw) return false;
  const p=JSON.parse(raw);
  if(p.deviceId!==deviceId||p.version!==(test.version||1)) return false;
  index=p.index||0;
  answers=p.answers||{};
  timeLeft=p.timeLeft||timeLeft;
  return true;
}

db.collection("tests").doc(testId).get().then(async d=>{
  test=d.data();
  const ver=test.version||1;

  const snap=await db.collection("results")
    .where("testId","==",testId)
    .where("ism","==",user.ism)
    .where("familiya","==",user.familiya)
    .where("deviceId","==",deviceId)
    .limit(1).get();

  if(!snap.empty && snap.docs[0].data().testVersion===ver){
    showClosed(snap.docs[0].data());
    return;
  }

  timeLeft=Number(test.duration||60)*60;
  loadProgress();
  startTimer();
  render();
});

function startTimer(){
  interval=setInterval(()=>{
    timer.innerText=`‚è± ${Math.floor(timeLeft/60)}:${String(timeLeft%60).padStart(2,"0")}`;
    timeLeft--;
    saveProgress();
    if(timeLeft<0){clearInterval(interval);finish();}
  },1000);
}

function render(){
  const q=test.questions[index];
  let html=`
    <div class="question-box">
      ${index+1}. ${q.text}
      ${q.image?`<div class="q-image"><img src="${q.image}"></div>`:""}
    </div>`;
const order = ["A","B","C","D"];

order.forEach(k=>{
  if(!q.options[k]) return;

  html+=`
    <div class="option ${answers[index]===k?"selected":""}" onclick="choose('${k}')">
      ${k}) ${q.options[k]}
    </div>`;
});

  html+=`
    <div class="nav">
      <button onclick="prev()">‚¨Ö Oldingi</button>
      <button onclick="next()">Keyingi ‚û°</button>
    </div>
    ${index===test.questions.length-1?'<button class="finish" onclick="finish()">TESTNI YAKUNLASH</button>':""}
  `;
  main.innerHTML=html;
}

function choose(v){answers[index]=v;saveProgress();render();}
function next(){if(index<test.questions.length-1){index++;saveProgress();render();}}
function prev(){if(index>0){index--;saveProgress();render();}}

function finish(){
  clearInterval(interval);
  localStorage.removeItem("progress_"+testId);

  let correct=0;
  const full=[];
  test.questions.forEach((q,i)=>{
    if(answers[i]===q.correct) correct++;
    full.push({...q,selected:answers[i]||null});
  });

  finalResult={answers:full};
const ball = correct * 2;
const spent = (Number(test.duration)*60 - timeLeft);
const min = Math.floor(spent / 60);
const sec = spent % 60;

let title = "‚ùå Attestatsiya Mock testidan o‚Äòtmadingiz";
let cls = "fail";

if(ball >= 80){
  title = "üîµ Oliy toifa balini to‚Äòpladingiz";
  cls = "success";
}else if(ball >= 70){
  title = "üü° Birinchi toifa balini to‚Äòpladingiz";
  cls = "gold";
}else if(ball >= 60){
  title = "üü† Ikkinchi toifa balini to‚Äòpladingiz";
  cls = "orange";
}

resultBox.className = "modal-box " + cls;
resultTitle.innerText = title;
resultScore.innerText = ball + " ball";

okCount.innerText = "To‚Äòg‚Äòri: " + correct;
noCount.innerText = "Noto‚Äòg‚Äòri: " + (full.length - correct);
resultTime.innerText = `‚è± Sarflangan vaqt: ${min} daqiqa ${sec} soniya`;


  db.collection("results").add({
    testId,
    testVersion:test.version||1,
    deviceId,
    ism:user.ism,
    familiya:user.familiya,
    ball:correct*2,
    answers:full,
    time:new Date().toLocaleString()
  });

  resultModal.style.display="flex";
}

function showAnalysis(){
  resultModal.style.display="none";
  timer.style.display="none";
  let html="<h2>üìä Test tahlili</h2>";
  finalResult.answers.forEach((q,i)=>{
    html+=`
      <div class="question-box" style="margin-top:20px">
        ${i+1}. ${q.text}
        ${q.image?`<div class="q-image"><img src="${q.image}"></div>`:""}
    `;
    const order = ["A","B","C","D"];

order.forEach(k=>{
  if(!q.options[k]) return;

  let cls="option";
  if(k===q.correct) cls+=" correct";
  else if(k===q.selected) cls+=" wrong";

  html+=`<div class="${cls}">${k}) ${q.options[k]}</div>`;
});

    html+=`
      <div class="note">‚úî To‚Äòg‚Äòri: ${q.correct} | ‚úñ Siz: ${q.selected||"-"}</div>
      </div>`;
  });
  main.innerHTML=html;
}

function showClosed(r){
  main.innerHTML=`
    <div class="banner">
      Siz bu testni topshirgansiz. Test qayta ochilgandan keyin yana topshira olasiz.
      <br><br>
      <button onclick='showAnalysisFromSaved(${JSON.stringify(r)})'>üìä Tahlilni ko‚Äòrish</button>
    </div>`;
}

function showAnalysisFromSaved(r){
  finalResult=r;
  showAnalysis();
}
</script>

</body>
</html>


